# 09. 시각적 회귀 테스트

## 시각적 회귀 테스트의 필요성

1. 스타일 변경 검증의 어려움 - 육안 확인 / 다양한 스타일 적용 방법 / 컴포넌트 기반 개발
2. 스냅샷 테스트로는 대체할 수 없다 - class 기반 / css modules 방식에 의한 제한
3. 헤드리스 브라우저의 한계 - 변경 부분을 검출하는 데 한계가 존재

## reg-cli로 이미지 비교하기

### reg-suit란?

reg-suit는 UI 컴포넌트의 시각적 회귀 테스트를 위한 오픈소스 도구이다.

웹 애플리케이션의 UI 변경 사항을 자동으로 감지하고 시각적으로 비교할 수 있게 해준다.

### 주요 기능

- **스크린샷 비교**: 이전 버전과 현재 버전의 UI 스크린샷을 자동으로 비교하여 차이점을 시각화한다.
- **클라우드 스토리지 통합**: AWS S3, Google Cloud Storage 등 다양한 클라우드 스토리지와 통합되어 스크린샷을 저장하고 관리할 수 있다.
- **CI/CD 통합**: GitHub Actions, CircleCI, Travis CI 등 다양한 CI/CD 도구와 쉽게 통할 수 있다.
- **플러그인 시스템**: 다양한 플러그인을 통해 확장 가능한 구조를 제공한다.

### 동작 플로우

> 대강 말로 표현하자면 아래와 같다?

1. 커밋 해시로 파일명을 지은 스냅샷셋 + 검증 결과 리포트 → 외부 저장소 전송(베이스 브랜치)
2. 작업 브랜치의 커밋에서 스냅샷셋 추출 ↔ 베이스 브랜치의 커밋에서 스냅샷셋 추출
3. 이후 작업 브랜치의 스냅샷셋 + 검증 결과 리포트 → 외부 저장소 전송(작업 브랜치)

### 환경 세팅

```json
// regconfig.json
{
  "core": {
    "workingDir": ".reg",
    "actualDir": "스크린샷_디렉토리",
    "thresholdRate": 0.05
  },
  "plugins": {
    "reg-keygen-git-hash-plugin": {
      "enabled": true
    },
    "reg-publish-s3-plugin": {
      "enabled": true,
      "bucketName": "your-aws-s3-bucket"
    }
  }
}
```

### 다양한 플러그인

- **reg-keygen-git-hash-plugin** - _키 생성 플러그인_ - 이 플러그인은 git 브랜치 그래프를 탐색하여 "어떤 커밋 해시와 비교해야 하는지" 식별하는 기능을 제공한다.
- **reg-simple-keygen-plugin** - _키 생성 플러그인_ - 이 플러그인은 임의의 문자열을 스냅샷 키로 사용할 수 있게 한다.
- **reg-publish-s3-plugin** - _퍼블리셔 플러그인_ - 이 플러그인은 S3 버킷에서 이전 스냅샷 이미지를 가져와 비교 시 기대 이미지로 사용한다. 비교 후, 이 플러그인은 현재(실제) 스냅샷 이미지와 비교 결과 보고서를 업로드한다.
- **reg-publish-gcs-plugin** - _퍼블리셔 플러그인_ - S3 플러그인과 유사한 대체 퍼블리셔 플러그인이다. S3 대신 Google Cloud Storage를 사용한다는 점이 다르다.
- **reg-notify-github-plugin** - _알림 플러그인_ - 이 플러그인은 reg-suit와 GitHub 앱을 통합한다. 이 플러그인과 앱을 설치하면 GitHub 커밋 상태와 PR 댓글을 통해 reg-suit 결과를 받을 수 있다.
- **reg-notify-gitlab-plugin** - _알림 플러그인_ - 이 플러그인은 reg-suit 결과를 GitLab 프로젝트의 머지 리퀘스트 댓글에 알린다.
- **reg-notify-github-with-api-plugin** - _알림 플러그인_ - 이 플러그인은 reg-suit 결과를 GHE(GitHub Enterprise) 저장소의 PR 댓글에 알린다.
- **reg-notify-slack-plugin** - _알림 플러그인_ - 이 플러그인은 인커밍 웹훅을 사용하여 Slack 채널에 reg-suit 결과를 알린다.
- **reg-notify-chatwork-plugin** - _알림 플러그인_ - 이 플러그인은 Chatwork API 토큰을 사용하여 Chatwork 채널에 reg-suit 결과를 알린다.

시각적 회귀 테스트 하면 Chromatic 가장 먼저 떠올리게 되는데 위 조합과의 차이를 간단하게 정리해보았다.

| 비교 항목        | Storycap + reg-suit     | Chromatic                    |
| ---------------- | ----------------------- | ---------------------------- |
| 유형             | 오픈소스 도구 조합      | 상용 클라우드 서비스         |
| 설치 및 설정     | 복잡함 (여러 단계 필요) | 간단함 (한 줄 명령어)        |
| UI 컴포넌트 캡처 | Storycap 담당           | 자체 캡처 기능 내장          |
| 브라우저 지원    | 주로 Chrome만           | 다양한 브라우저 지원         |
| 이미지 비교 방식 | 기본적인 픽셀 비교      | 지능형 비교 (오차 허용)      |
| 이미지 저장 위치 | 자체 서버/클라우드 필요 | Chromatic 서버에 자동 저장   |
| 팀 협업 기능     | 기본적 (PR 댓글 정도)   | 풍부함 (리뷰, 승인, 댓글 등) |
| 비용             | 무료 (서버 비용 별도)   | 기본 무료 + 유료 구독        |
| 맞춤 설정 가능성 | 매우 높음 (코드 수준)   | 제한적 (제공된 옵션만)       |
| 관리 부담        | 높음 (직접 모두 관리)   | 낮음 (서비스에서 관리)       |

### 시각적 회귀 테스트를 활용한 리팩토링

1. 반응형 디자인에 활용하기
2. 릴리스 직전 리팩토링에 활용하기 - 전역적으로 끼치는 영향에 대한 확인 용이
3. 스토리 커밋 습관화로 시작하는 시각적 회귀 테스트 - 테스트하기 쉬운 UI 컴포넌트 레벨

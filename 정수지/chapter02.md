# 테스트 방법과 테스트 전략

## 테스트 범위와 목적

상황에 맞는 테스트를 작성하기 위해 프론트엔드의 테스트의 범위와 목적을 이해해보자

### 테스트 범위

웹 애플리케이션은 여러 모듈을 조합해 만든다. 한 가지 기능을 구현할 때도 다음과 같이 많은 모듈을 활용한다.

1. 라이브러리가 제공하는 함수
2. 로직을 담당하는 함수
3. UI 관련 함수
4. 웹 API 클라이언트
5. API 서버
6. 데이터베이스 서버

테스트를 작성할 때는 어디부터 어디까지 커버하는 테스트인지 주의해야 한다.
프론트엔드 개발의 테스트 범위는 크게 4가지로 구분된다.

- 정적 분석
  - 타입스크립트나 ESLint가 제공하는 기능을 활용
  - 각 모듈의 검증뿐만 아니라 2~3 검증, 3~4 검증처럼 인접 모듈을 연계해 사용할 때의 문제점도 증
- 단위 테스트
  - 한 가지 모듈에 한정해 해당 모듈이 제공하는 기능을 검증하는 테스트
  - 독립된 환경에서 검증하기 때문에 실제로 애플리케이션을 사용할 때는 거의 발생하지 않는 케이스(코너 케이스) 검증에 적합
    - @ 그럼 코너 케이스 검증이 왜 필요한 걸까?
- 통합 테스트
  - 1~4, 2~3 관련 함수처럼 모듈 조합으로 제공되는 기능을 검증하는 테스트
  - 범위가 넓어질수록 효율적인 테스트가 가능하지만 상대적으로 대략적인 검증에 그치게 됨
- E2E 테스트
  - 1~4를 통틀어 헤드리스 브라우저와 UI 자동화 도구를 결합하여 검증하는 테스트
  - 가장 광범위한 통합 테스트
  - 실제 애플리케이션을 사용할 때와 가장 유사한 테스트

### 테스트 목적

테스트 타입은 테스트 목적에 따라 분류된다. 테스트 타입은 검증 목적에 맞게 설정해야 하며, 테스트 타입마다 적절한 테스트 도구가 있다. 한가지 도구 혹은 여러 도구를 조합해 검증하는 경우도 있다. 테스트 타입에는 기능 테스트, 비기능 테스트, 화이트박스 테스트, 회귀 테스트가 있다.

- 기능 테스트(인터랙션 테스트)
  - 개발된 기능에 문제가 없는지 검증하는 테스트
  - 웹 프론트엔드의 대부분의 기능은 UI 컴포넌트 조작에서 시작하기 때문에 인터랙션 테스트가 기능 테스트가 될 때가 많고, 중요성 또한 높음
  - 실제 브라우저 API를 사용하는 것이 중요한 테스트라면 헤드리스 브라우저와 UI 자동화 도구를 사용하는 것이 좋음
- 비기능 테스트(접근성 테스트)
  - 신체적, 정신적 특성에 따른 차이 없이 동등하게 제품을 사용할 수 있는지 검증하는 테스트다. 최근에는 전 세계적으로 웹 접근성 관련 API가 여러 플랫폼에 추가돼 테스트 자동화를 할 때 객관적으로 검증할 수 있는 환경이 갖춰지고 있음
- 회귀 테스트
  - 특정 시점을 기준으로 전후 차이를 비교해 문제가 있는지 검증하는 테스트
  - 웹 프런트엔드는 시각적으로 보이는 UI 컴포넌트를 개발하기 때문에 시각적 회귀 테스트가 중요함

## 프론트엔드 테스트 범위

### 정적 분석

타입스크립트를 활용하는 정적 분석은 버그를 조기에 발견할 수 있도록 한다.
특히, 타입 추론은 런타임 작동을 예측해주기 때문에 아주 유용하다.
if 문 분기에 타입 추론이 적용되면 값을 안전하게 다룰 수 있다.

```typescript
function getMessage(name: string | undefined) {
  const a = name; // a: string | undefined
  if (!name) {
    return `Hello anonymous`;
  }
  const b = name; // b: string
  return `Hello ${name}`;
}
```

+. 궁금 Point. 왜 위 코드에서 별도의 a, b 상수를 입력했을까?
단지, 타입 추론이 어떻게 되는지에 대한 명시를 위한 방법이었다고 파악됨, 상수 없이도 타입 내로잉을 통해 상수 옆 주석처럼 표시된 것 처럼 타입 추론이 된다.

```typescript
function checkType(type: "A" | "B" | "C"): string {
  const message: string = "valid type";
  if (type === "A") {
    return message;
  }
  if (type === "B") {
    return message;
  }
  throw new Error("invalid type");
}
```

+. 궁금 Point. 함수의 반환 타입이 string인데 throw new Error()를 사용해도 타입스크립트에서 문제가 없는가?
타입스크립트에서 throw new Error()는 실제로 값을 반환하는 것이 아닌 실행을 중단시키는 역할을 한다. throw는 함수가 정상적으로 끝나는 경우가 아니라 예외를 던지고 종료하는 경우이기 때문에 타입 시스템에서는 반환값을 고려하지 않아도 된다.
조금 더 알아보자면, throw new Error()는 타입스크립트에서 never 타입을 가진다고 볼 수 있다.

+. 궁금 Point. never 타입이란?
never 타입은 절대 반환되지 않는 함수에서 사용된다.
함수가 끝까지 실행되지 않고 항상 예외를 던지거나 무한 루프에 빠지는 경우에 발생한다.

+. 궁금 Point. React에서 해당 함수를 사용했을 때, 에러 바운더리가 정상적으로 동작하는가?
에러 바운더리가 존재한다면 정상적으로 동작한다.
React는 함수형 컴포넌트 내에서 throw가 발생하면, 해당 컴포넌트의 렌더링 과정이 중단되고, 에러가 가장 가까운 에러 바운더리로 전파됩니다.

또한, 코드 가이드라인을 제공하는 ESLint도 정적 분석 도구 중 하나다. ESLint는 부적절한 구문을 수정해서 잠재적으로 발생할 수 있는 버그를 사전에 방지한다.

### 단위 테스트

가장 기초적인 테스트다. 테스트할 모듈이 특정 입력값을 받아 기대하는 출력값을 반환하는지 테스트한다. SPA 개발에서는 UI 컴포넌트는 입력값(Prop)에 알맞은 출력값(HTML 블록)을 반환하기 때문에 일반적인 함수와 같은 방법으로 테스트 할 수 있어 테스트하기 쉽다.

모듈에 따라 거의 발생하지 않는 케이스(코너 케이스)에 한해서만 예외를 발생시키는 것이 나은 경우도 있다. 어떤 상황에서 예외를 발생시켜야 할지 판단하는데 도움이 된다. 이런 상황은 일어날 수 없을까? 일어난다면 어떻게 처리해야하는가와 같이 거듭된 검토 과정에서 미처 고려하지 못했던 부분을 발견할 수 있다.

### 통합 테스트

여러 모듈을 연동한 기능을 테스트한다. 커다란 UI 컴포넌트는 여러 모듈을 조합해 기능을 제공하며, 기능은 주로 인터랙션에서 시작된다.

'셀렉트 박스를 조작 -> URL 검색 쿼리 변경 -> 검색 쿼리가 변경되어 데이터 취득 API 호출 -> 목록 화면 갱신' 과 같은 순서로 처리되는지를 확인하는 테스트다.

상황에 따라서는 범위를 좁혀 '셀렉트 박스를 조작 -> URL 검색 쿼리 변경'만 실행되는 것처럼 좁은 범위의 테스트가 효율적일 때도 있다. 예로는 코너 케이스 때문에 테스트가 복잡해지면 범위를 좁혀 통합 테스트를 실시해야 테스트 목적이 명확해진다.

### E2E 테스트

End to End Test는 UI 테스트뿐만 아니라 외부 스토리지와 같이 연동중인 하위 시스템을 포함하는 테스트다. 입력 내용에 따라 저장된 값이 갱신되기 때문에 UI는 물론 연동된 외부 기능이 정상적으로 작동하는지 검증할 수 있다.

## 프론트엔드 테스트의 목적

### 기능 테스트(인터랙션 테스트)

웹 프론트엔드는 주로 사용자가 조작할 UI 컴포넌트를 개발한다. 사용자 조작에 따라 상태를 변경하고, 사용자에게 원하는 정보를 제공하기 위해 화면을 갱신한다. 때문에 웹 프론트엔드의 기능 테스트는 인터렉션 테스트가 대부분이다.

인터렉션 테스트라고 하면 크로미엄(Chromium)과 같은 실제 브라우저를 헤드리스 모드로 실행하여 UI 테스트를 자동화를 실시하는 이미지가 떠오를 것이다. 하지만 React와 같은 라이브러리로 구현된 UI 컴포넌트에는 브라우저 없이도 테스트할 수 있는 가상 브라우저 환경이 있다.

브라우저 없이도 가능한 인터랙션 테스트 사례는 아래와 같다.

- 버튼을 클릭하면 콜백 함수가 호출된다.
- 문자를 입력하면 전송 버튼이 활성화된다.
- 로그아웃 버튼을 클릭하면 로그인 페이지로 이동한다.

단, 가상 브라우저만으로는 스크롤이나 세션 스토리지 같은 기능은 테스트할 수 없다. 실제 브라우저가 없으면 수행하기 어려운 기능의 테스트는 헤드리스 브라우저와 UI 자동화 도구를 사용한다.

실제 브라우저가 필요한 인터랙션 테스트 사례는 아래와 같다.

- 무한 스크롤 동작 (맨 아래로 스크롤을 내리면 추가 데이터를 가져옴)
- 세션 스토리지에 저장된 값을 불러옴

### 비기능 테스트(접근성 테스트)

접근성 테스트는 비기능 테스트의 한 종류다. '키보드만으로 웹사이트를 이용할 수 있는가', '명암비가 시인성에 문제는 없는가'와 같은 다양한 검증 항목이 있다. 각 검증에 따라 알맞은 적절한 테스트 도구를 사용한다.

예를 들면, 체크 박스를 체크할 수 있는가. 오류 응답을 받았을때 오류 문구를 렌더링한다. 렌더링된 화면에 접근성 위반 사례가 있는가. 등이 있다.

### 시각적 회귀 테스트

CSS는 UI 컴포넌트에 정의된 스타일뿐만 아니라 브라우저에 적용된 모든 스타일의 영향을 받는다. 회귀 테스트 중 하나인 시각적 회귀 퇴스트는 헤드리스 브라우저에 그려진 내용을 캡쳐하여 캡처된 이미지 간 차이를 검증한다. 초기에 렌더링된 상태만 캡쳐하여 비교하는 것에 그치지 않고 사용자 조작으로 변경된 화면까지 캡쳐하여 비교한다.

버튼 스타일에 차이가 없는지, 메뉴바를 열었을때 화면에 차이가 없는지, 렌더링 된 화면에 차이가 없는지를 검증한다.

## 테스트 전략 모델

아래 이미지는 테스트 범위와 비용의 상관관계를 나타냅니다.
![testing pyramid](https://blog.getmason.io/content/images/2020/11/Testing-pyramid--6--1.jpg)
(출처: https://getmason.io/blog/post/test-pyramid/)

위로 갈 수록 실제 제품과 유사한 테스트가 가능합니다.
하지만 위로 갈 수록 시간과 비용이 많이 필요합니다.
테스트용 데이터베이스 서버를 준비하는 등 실제 환경과 최대한 유사한 환경을 구축해야 하고, 테스트할 때마다 제품과 연동된 외부 시스템의 응답도 기다려야한다.

이러한 발생 비용은 개발팀에 큰 영향을 미치기 때문에 충분한 논의가 필요합니다.

### 아이스크림 콘과 테스트 피라미드

상층부 테스트 전략이 높은 아이스크림 콘은 안티패턴으로 자주 언급됩니다.
운용 비용이 높고, 외부 모듈의 의존성 때문에 가끔씩 실패하는 불안정한 테스트가 비교적 많습니다.

모든 테스트가 통과되는데 수십 분 이상이 걸린다면 개발 흐름에 나쁜 영향을 주게 됩니다. 더 나은 개발 환경을 만들고자 테스트를 자동화 한 것이 오히려 개발 경험을 헤치는 상황이 발생하게 됩니다. 그렇다고 실행 빈도를 줄이면 테스트 자동화의 신뢰성이 낮아집니다.

테스트 피라미드는 하층부의 테스트 비중이 높을수록 더욱 안정적이고 가성비 높은 테스트가 가능하다는 것이 테스트 피라미드의 핵심입니다.

### 테스팅 트로피

![testing tropy](https://miro.medium.com/v2/resize:fit:1200/1*LiA9PRum8qcktJ5mZBumEg.png)
(출처 : https://jero786.medium.com/write-test-not-too-many-mostly-integration-bad298f69e1a)
켄트 도즈가 만든 테스트 전략 모델이다. 이 모델의 핵심은 통합 테스트 비중이 가장 높아야 한다는 것이다. 사용자 조작을 기점으로 한 통합 테스트 비중이 높을수록 더욱 우수한 테스트 전략이라는 의도가 있다.

프론트엔드 개발에서 단일 UI 컴포넌트로 구현되는 기능은 거의 없다. 버튼을 누르면 API를 호출하는 기능도 여러 컴포넌트의 조합으로 구현된다. 또한, 프론트엔드 기능은 버튼을 누르는 것과 같은 사용자 조작에서 시작한다.

테스팅 라이브러리와 제스트를 사용하면 헤드리스 브라우저 없이도 사용자 조작을 재현해 테스트 할 수 있어 실행 속도가 빠르면서도 실제 제품과 유사한 테스트가 가능하다.

## 테스트 전략 계획

테스트 전략을 수립할 때 판단 기준으로 참고가 될 사례들을 살펴보자.

### 테스트가 없어 리팩터링이 불안한 경우

- 릴리즈가 된 기능을 목록으로 정리하기
- 변경 전후로 결함이 발생하지 않았는지 검증하는 회귀 테스트 작성
- 웹 API 서버에 대한 의존성을 분리하기 위해 목 서버를 활용해 통합 테스트 실시

### 반응형으로 제작된 프로젝트

- 반응형 웹은 하나의 HTML에서 여러 형태의 화면을 제공한다. 예를 들어 CSS, JavaScript, user agent가 변하면 다른 화면이 나타난다.
- 하나의 파일로 여러 화면을 제공하면 PC용 디자인을 수정했으나 모바일 디자인도 수정되는 상항이 발생한다. 이런 경우 시각적 회귀 테스트를 실시한다.
- 스토리북은 UI 컴포넌트 단위로 시각적 회귀 테스트가 가능하다. reg-suit을 활용한 시각적 회귀 테스트도 있다.

### 데이터베이스를 포함한 E2E 테스트가 필요한 경우

- 목 서버가 아닌 실제 웹 서버 API를 사용해 E2E 테스트를 하고 싶다면 테스트용 스테이징 환경을 사용해야 한다.
- E2E 테스트는 테스트 엔지니어가 프로젝트를 릴리스하기 전에 테스트 계획서를 보면서 수동으로 하는 경우가 많고, 브라우저를 사용한 UI 자동화 방식으로 테스트하는 경우도 있다.
- 또는 스테이징 환경을 만들지 않고 테스트할 시스템을 컨테이너화해 CI 환경에서 실행한 후 연동 중인 여러 시스템과 함께 테스트하는 것이다. 비교적 환경 구축 비용이 적고, 개발자 혼자서도 구축할 수 있는 장점이 있다.

---

+. 테스트를 너무 많이 작성하는 것은 아닌지 되돌아보자
테스트 타입 및 전략은 무수히 많다. 여러 종류의 테스트를 작성하다 보면 테스트 범위가 중복된다면 어떤 점이 중요한지를 파악하고 중요한 테스트만 작성하는 것으로도 충분하다는 결론을 얻을 수 있다.
프로젝트에 알맞은 기술 구성은 무엇이며, 어떤 테스트 전략이 프로젝트에 적합한지 항상 되돌아봐야한다.

<br/> <br/>

---

### 더 알아보기

- [ ] ErrorBoundary 설정
- [ ] 헤드리스 브라우저? 헤드리스 모드
- [ ] 경험과 사례로 풀어낸 성공하는 애자일 책

# Chapter 10. E2E 테스트

## 10.1 E2E 테스트란

- E2E 테스트는 브라우저를 사용할 수 있기 때문에, 브라우저 고유의 API를 사용하는 상황이나 화면을 이동하며 테스트해야하는 상황에 안성맞춤이다

### 10.1.1 브라우저 고유 기능과 연동한 UI 테스트

- 다음과 같은 상황들은 jsdom만으로는 테스트할 수 없다:
    - 화면 간의 이동
    - 화면 크기를 측정하여 실행될는 로직
    - CSS의 미디어 쿼리를 사용한 반응형 처리
    - 스크롤 위치에 따른 이벤트 발생
    - 쿠키나 로컬 저장소 사용

### 10.1.2 데이터베이스 및 서브 시스템과 연동한 E2E 테스트

- E2E 테스트 프레임워크는 UI 자동화 기능으로 실제 애플리케이션을 브라우저 너머에서 조작한다:
    - DB와 연동하여 데이터를 불러오거나 저장한다
    - 외부 저장소 서비스와 연동하여 이미지 등을 업로드한다
- 이처럼 E2E 테스트는 표현 계층, 응용 계층, 영속 계층을 연동하여 검증하므로 실제 상황과 유사성이 높은 테스트로 자리매김했다. 한편 많은 시스템과 연동하기 때문에 실행 시간이 길고, 불안정하다

---

## 10.2 Playwright 설치 및 기초

- 로케이터는 Playwright의 핵심 API이다. 현재 페이지에서 엘리먼트를 가져온다. 테스팅 라이브러리의 쿼리와 마찬가지고 접근성 기반 로케이터를 우선적으로 사용하는 것을 권장한다

---

## 10.4 개발 환경에서 E2E 테스트 실행하기

- E2E 테스트를 작성하다 보면 테스트가 통과되지 않을 때가 있다. 이럴 때는 Playwright 검사 도구로 원인을 파악해야 한다. 테스트를 실행하는 커맨드에 `--debug` 옵션을 붙이면 `headed`모드(브라우저를 열어서 눈으로 자동화된 UI 테스트를 확인)로 테스트가 시작된다
    
    ```bash
    npx playwright test Login.spec.ts --debug
    ```
    

---

## 10.5 프리즈마를 활용한 테스트

- UI 조작으로 DB를 갱신할 수 있는지도 검증할 수 있다
- DB와 연동된 E2E 테스트는 테스트를 실행할 때마다 DB를 초기화하고 테스트용 데이터를 추가해야한다

### 10.5.1 프리즈마 스키마

- 프리즈마는 프리즈마 스키마라는 엔티티간 관계를 나타내는 도메인 특화 언어를 사용해 DB를 정의한다
- 해당 스키마 파일이 마이그레이션 스크립트로 변환되는 동시에 프리즈마 클라이언트(=애플리케이션 코드에서 DB에 쿼리를 보내는 클라이언트)가 생성된다

---

## 10.7 프로필 기능 E2E 테스트

- E2E 테스트에서는 다음과 같은 작업이 정상적으로 연동되는지 검증한다:
    - UI를 조작하여 프로필 갱신 API 요청을 발생시킨다
    - API Routes가 작동하고 DB에 값이 저장된다
    - 세션에 저장된 값이 갱신된다
    - 새로운 페이지 제목은 갱신된 세션값을 참조한다

---

## 10.12 불안정한 테스트 대처 방법

- 불안정한 테스트는 네트워크 지연이나 메모리 부족에 의한 서버 응답 지연 등 다양한 원인으로 발생한다. 앞서 언급한 것처엄 테스트 실행 순서의 영향으로 의도하지 않은 상태에서 테스트를 시작하여 문제가 발생하기도 한다
- 불안정한 테스트에 직면했을 때의 몇 가지 대처 방법은 다음과 같다:
    - 실행할 때마다 DB 재설정하기
    - 테스트마다 사용자를 새로 만들기
    - 테스트 간 리소스가 경합하지 않도록 주의하기
    - 빌드한 애플리케이션 서버로 테스트하기
    - 비동기 처리 대기하기
    - `--debug`로 테스트 실패 원인 조사하기
    - CI 환경과 CPU 코어 수 맞추기

### 10.12.8 테스트 범위 최적화

- 테스트 피라미드의 상층부에 가까운 테스트일수록 실제 상황과 유사한 테스트가 가능하지만, 반대로 불안정성이 증가하고 실행 시간도 길어진다
- E2E 테스트를 넓은 범위의 통합 테스트로 대체할 수 있으면 더 적은 비용으로 안정적인 테스트를 할 수 있다